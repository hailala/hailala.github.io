<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>hailala&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="我的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.a5a0d673.css" as="style"><link rel="preload" href="/assets/js/app.3ef41cfa.js" as="script"><link rel="preload" href="/assets/js/4.db7ba0a9.js" as="script"><link rel="preload" href="/assets/js/1.80dd9a38.js" as="script"><link rel="preload" href="/assets/js/7.7c4ddee7.js" as="script"><link rel="prefetch" href="/assets/js/10.b841e20b.js"><link rel="prefetch" href="/assets/js/11.ad537902.js"><link rel="prefetch" href="/assets/js/12.0047dc98.js"><link rel="prefetch" href="/assets/js/13.9675f7cc.js"><link rel="prefetch" href="/assets/js/14.6ef22720.js"><link rel="prefetch" href="/assets/js/15.16c3a444.js"><link rel="prefetch" href="/assets/js/16.43a9cd91.js"><link rel="prefetch" href="/assets/js/17.4e7acc00.js"><link rel="prefetch" href="/assets/js/18.e1d93580.js"><link rel="prefetch" href="/assets/js/19.287e15b0.js"><link rel="prefetch" href="/assets/js/20.e6660b34.js"><link rel="prefetch" href="/assets/js/21.8c8a3637.js"><link rel="prefetch" href="/assets/js/22.f2479241.js"><link rel="prefetch" href="/assets/js/23.812ed3f9.js"><link rel="prefetch" href="/assets/js/24.799f0f51.js"><link rel="prefetch" href="/assets/js/25.a0aef80f.js"><link rel="prefetch" href="/assets/js/26.591f7e07.js"><link rel="prefetch" href="/assets/js/27.511fef4e.js"><link rel="prefetch" href="/assets/js/28.84ae26c9.js"><link rel="prefetch" href="/assets/js/29.5bddd49e.js"><link rel="prefetch" href="/assets/js/3.1b66ae0b.js"><link rel="prefetch" href="/assets/js/30.e983f7d4.js"><link rel="prefetch" href="/assets/js/31.232b21b3.js"><link rel="prefetch" href="/assets/js/32.4063c6d6.js"><link rel="prefetch" href="/assets/js/33.30ad69c9.js"><link rel="prefetch" href="/assets/js/5.4b27f8c3.js"><link rel="prefetch" href="/assets/js/6.96a27913.js"><link rel="prefetch" href="/assets/js/8.a3beb34e.js"><link rel="prefetch" href="/assets/js/9.ee0645bc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a5a0d673.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>hailala's Blog</h3> <p class="description" data-v-59e6cb88>我的个人网站</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="hailala's Blog" class="logo"> <span class="site-name">hailala's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="undefined"></i>
  前端
</a></div><div class="nav-item"><a href="/back/" class="nav-link router-link-active"><i class="undefined"></i>
  后端
</a></div><div class="nav-item"><a href="/job/" class="nav-link"><i class="undefined"></i>
  经验
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>2</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="undefined"></i>
  前端
</a></div><div class="nav-item"><a href="/back/" class="nav-link router-link-active"><i class="undefined"></i>
  后端
</a></div><div class="nav-item"><a href="/job/" class="nav-link"><i class="undefined"></i>
  经验
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back/redis/快速入门.html" class="sidebar-link">快速入门</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back/netty/Netty01-nio.html" aria-current="page" class="active sidebar-link">NIO</a></li><li><a href="/back/netty/Netty02-入门.html" class="sidebar-link">Netty入门</a></li><li><a href="/back/netty/Netty03-进阶.html" class="sidebar-link">Netty进阶</a></li><li><a href="/back/netty/Netty04-优化与源码.html" class="sidebar-link">Netty优化与源码</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title"></h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1>NIO</h1> <p>non-blocking io 非阻塞 IO</p> <h2 id="_1-三大组件"><a href="#_1-三大组件" class="header-anchor">#</a> 1. 三大组件</h2> <h3 id="_1-1-channel-buffer"><a href="#_1-1-channel-buffer" class="header-anchor">#</a> 1.1 Channel &amp; Buffer</h3> <p>channel 有一点类似于 stream，它就是读写数据的<strong>双向通道</strong>，可以从 channel 将数据读入 buffer，也可以将 buffer 的数据写入 channel，而之前的 stream 要么是输入，要么是输出，channel 比 stream 更为底层</p> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> LR
channel <span class="token arrow operator">--&gt;</span> buffer
buffer <span class="token arrow operator">--&gt;</span> channel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>常见的 Channel 有</p> <ul><li>FileChannel</li> <li>DatagramChannel</li> <li>SocketChannel</li> <li>ServerSocketChannel</li></ul> <p>buffer 则用来缓冲读写数据，常见的 buffer 有</p> <ul><li>ByteBuffer
<ul><li>MappedByteBuffer</li> <li>DirectByteBuffer</li> <li>HeapByteBuffer</li></ul></li> <li>ShortBuffer</li> <li>IntBuffer</li> <li>LongBuffer</li> <li>FloatBuffer</li> <li>DoubleBuffer</li> <li>CharBuffer</li></ul> <h3 id="_1-2-selector"><a href="#_1-2-selector" class="header-anchor">#</a> 1.2 Selector</h3> <p>selector 单从字面意思不好理解，需要结合服务器的设计演化来理解它的用途</p> <h4 id="多线程版设计"><a href="#多线程版设计" class="header-anchor">#</a> 多线程版设计</h4> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TD
<span class="token keyword">subgraph</span> 多线程版
t1<span class="token text string">(thread)</span> <span class="token arrow operator">--&gt;</span> s1<span class="token text string">(socket1)</span>
t2<span class="token text string">(thread)</span> <span class="token arrow operator">--&gt;</span> s2<span class="token text string">(socket2)</span>
t3<span class="token text string">(thread)</span> <span class="token arrow operator">--&gt;</span> s3<span class="token text string">(socket3)</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="⚠️-多线程版缺点"><a href="#⚠️-多线程版缺点" class="header-anchor">#</a> ⚠️ 多线程版缺点</h4> <ul><li>内存占用高</li> <li>线程上下文切换成本高</li> <li>只适合连接数少的场景</li></ul> <h4 id="线程池版设计"><a href="#线程池版设计" class="header-anchor">#</a> 线程池版设计</h4> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TD
<span class="token keyword">subgraph</span> 线程池版
t4<span class="token text string">(thread)</span> <span class="token arrow operator">--&gt;</span> s4<span class="token text string">(socket1)</span>
t5<span class="token text string">(thread)</span> <span class="token arrow operator">--&gt;</span> s5<span class="token text string">(socket2)</span>
t4<span class="token text string">(thread)</span> <span class="token arrow operator">-.-&gt;</span> s6<span class="token text string">(socket3)</span>
t5<span class="token text string">(thread)</span> <span class="token arrow operator">-.-&gt;</span> s7<span class="token text string">(socket4)</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="⚠️-线程池版缺点"><a href="#⚠️-线程池版缺点" class="header-anchor">#</a> ⚠️ 线程池版缺点</h4> <ul><li>阻塞模式下，线程仅能处理一个 socket 连接</li> <li>仅适合短连接场景</li></ul> <h4 id="selector-版设计"><a href="#selector-版设计" class="header-anchor">#</a> selector 版设计</h4> <p>selector 的作用就是配合一个线程来管理多个 channel，获取这些 channel 上发生的事件，这些 channel 工作在非阻塞模式下，不会让线程吊死在一个 channel 上。适合连接数特别多，但流量低的场景（low traffic）</p> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TD
<span class="token keyword">subgraph</span> selector 版
thread <span class="token arrow operator">--&gt;</span> selector
selector <span class="token arrow operator">--&gt;</span> c1<span class="token text string">(channel)</span>
selector <span class="token arrow operator">--&gt;</span> c2<span class="token text string">(channel)</span>
selector <span class="token arrow operator">--&gt;</span> c3<span class="token text string">(channel)</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>调用 selector 的 select() 会阻塞直到 channel 发生了读写就绪事件，这些事件发生，select 方法就会返回这些事件交给 thread 来处理</p> <h2 id="_2-bytebuffer"><a href="#_2-bytebuffer" class="header-anchor">#</a> 2. ByteBuffer</h2> <p>有一普通文本文件 data.txt，内容为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1234567890abcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 FileChannel 来读取文件内容</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">RandomAccessFile</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment">// 向 buffer 写入</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;读到字节数：{}&quot;</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 切换 buffer 读模式</span>
                buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 切换 buffer 写模式</span>
                buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 读到字节数：10
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 读到字节数：4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 读到字节数：-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-1-bytebuffer-正确使用姿势"><a href="#_2-1-bytebuffer-正确使用姿势" class="header-anchor">#</a> 2.1  ByteBuffer 正确使用姿势</h3> <ol><li>向 buffer 写入数据，例如调用 channel.read(buffer)</li> <li>调用 flip() 切换至<strong>读模式</strong></li> <li>从 buffer 读取数据，例如调用 buffer.get()</li> <li>调用 clear() 或 compact() 切换至<strong>写模式</strong></li> <li>重复 1~4 步骤</li></ol> <h3 id="_2-2-bytebuffer-结构"><a href="#_2-2-bytebuffer-结构" class="header-anchor">#</a> 2.2 ByteBuffer 结构</h3> <p>ByteBuffer 有以下重要属性</p> <ul><li>capacity</li> <li>position</li> <li>limit</li></ul> <p>一开始</p> <p><img src="data:image/png;base64,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iEgATMhEREQCYEImIiISABMyERGRAJiQiYiIBDC5q6tr1EFjifFFLBGRqAYe2wJ1nGRs8MZOjoqKGvWORhvji1giIpE5H9sCdZxkbHDHcsiaiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATAhExERCQAJmQiIiIBMCETEREJgAmZiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATA5ReJiHyAyy8y1ttYLr9IROQDXH6Rsd7GcsiaiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATAhExERCQAJmQiIiIBMCETEREJgAmZiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATA5ReJiHyAyy8y1ttYLr9IROQDXH6Rsd7GcsiaiIhIAEzIREREApjkcDgcownwpqtusVgQFxc37HZarXZM+yciChRJkpSvRRwOHc5Ij8++LpftvU/IHjITMhEFkxUrVgS6CjQOTA50BTypqKhwe41nYOLHsr3+KZft9U+sN+0lGgshe8hEREQTDRMyERGRAJiQiYiIBMCETEREJAAmZCIiIgEwIRMREQmACZmIiEgATMhEREQCmNTZ2TmqR2cSERGR7/0f6/zmIeaGc4AAAAAASUVORK5CYII=" alt=""></p> <p>写模式下，position 是写入位置，limit 等于容量，下图表示写入了 4 个字节后的状态</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>flip 动作发生后，position 切换为读取位置，limit 切换为读取限制</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>读取 4 个字节后，状态</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>clear 动作发生后，状态</p> <p><img src="data:image/png;base64,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iEgATMhEREQCYEImIiISABMyERGRAJiQiYiIBDC5q6tr1EFjifFFLBGRqAYe2wJ1nGRs8MZOjoqKGvWORhvji1giIpE5H9sCdZxkbHDHcsiaiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATAhExERCQAJmQiIiIBMCETEREJgAmZiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATA5ReJiHyAyy8y1ttYLr9IROQDXH6Rsd7GcsiaiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATAhExERCQAJmQiIiIBMCETEREJgAmZiIhIAEzIREREAmBCJiIiEgATMhERkQCYkImIiATA5ReJiHyAyy8y1ttYLr9IROQDXH6Rsd7GcsiaiIhIAEzIREREApjkcDgcownwpqtusVgQFxc37HZarXZM+yciChRJkpSvRRwOHc5Ij8++LpftvU/IHjITMhEFkxUrVgS6CjQOTA50BTypqKhwe41nYOLHsr3+KZft9U+sN+0lGgshe8hEREQTDRMyERGRAJiQiYiIBMCETEREJAAmZCIiIgEwIRMREQmACZmIiEgATMhEREQCmNTZ2TmqR2cSERGR7/0f6/zmIeaGc4AAAAAASUVORK5CYII=" alt=""></p> <p>compact 方法，是把未读完的部分向前压缩，然后切换至写模式</p> <p><img src="/assets/img/0022.a46df9c4.png" alt=""></p> <h4 id="💡-调试工具类"><a href="#💡-调试工具类" class="header-anchor">#</a> 💡 调试工具类</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteBufferUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">BYTE2CHAR</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">HEXDUMP_TABLE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">256</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">HEXPADDING</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">HEXDUMP_ROWPREFIXES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">65536</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">BYTE2HEX</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">BYTEPADDING</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">DIGITS</span> <span class="token operator">=</span> <span class="token string">&quot;0123456789abcdef&quot;</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">HEXDUMP_TABLE</span><span class="token punctuation">[</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">DIGITS</span><span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token constant">HEXDUMP_TABLE</span><span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">DIGITS</span><span class="token punctuation">[</span>i <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token comment">// Generate the lookup table for hex dump paddings</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">HEXPADDING</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> padding <span class="token operator">=</span> <span class="token constant">HEXPADDING</span><span class="token punctuation">.</span>length <span class="token operator">-</span> i<span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>padding <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> padding<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;   &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token constant">HEXPADDING</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Generate the lookup table for the start-offset header in each row (up to 64KiB).</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">HEXDUMP_ROWPREFIXES</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">NEWLINE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">&amp;</span> <span class="token number">0</span>xFFFFFFFFL <span class="token operator">|</span> <span class="token number">0</span>x100000000L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">setCharAt</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">HEXDUMP_ROWPREFIXES</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Generate the lookup table for byte-to-hex-dump conversion</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">BYTE2HEX</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">BYTE2HEX</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">' '</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">byteToHexStringPadded</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Generate the lookup table for byte dump paddings</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">BYTEPADDING</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> padding <span class="token operator">=</span> <span class="token constant">BYTEPADDING</span><span class="token punctuation">.</span>length <span class="token operator">-</span> i<span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>padding<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> padding<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token constant">BYTEPADDING</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Generate the lookup table for byte-to-char conversion</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">BYTE2CHAR</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">0x1f</span> <span class="token operator">||</span> i <span class="token operator">&gt;=</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">BYTE2CHAR</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'.'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token constant">BYTE2CHAR</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 打印所有内容
     * @param buffer
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">debugAll</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> oldlimit <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> origin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">appendPrettyHexDump</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;+--------+-------------------- all ------------------------+----------------+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;position: [%d], limit: [%d]\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldlimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>oldlimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 打印可读取内容
     * @param buffer
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">debugRead</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">appendPrettyHexDump</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;+--------+-------------------- read -----------------------+----------------+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;position: [%d], limit: [%d]\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">appendPrettyHexDump</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> dump<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOutOfBounds</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IndexOutOfBoundsException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;expected: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;0 &lt;= offset(&quot;</span> <span class="token operator">+</span> offset <span class="token operator">+</span> <span class="token string">&quot;) &lt;= offset + length(&quot;</span> <span class="token operator">+</span> length
                            <span class="token operator">+</span> <span class="token string">&quot;) &lt;= &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;buf.capacity(&quot;</span> <span class="token operator">+</span> buf<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
                <span class="token string">&quot;         +-------------------------------------------------+&quot;</span> <span class="token operator">+</span>
                        <span class="token constant">NEWLINE</span> <span class="token operator">+</span> <span class="token string">&quot;         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |&quot;</span> <span class="token operator">+</span>
                        <span class="token constant">NEWLINE</span> <span class="token operator">+</span> <span class="token string">&quot;+--------+-------------------------------------------------+----------------+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> startIndex <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> fullRows <span class="token operator">=</span> length <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> remainder <span class="token operator">=</span> length <span class="token operator">&amp;</span> <span class="token number">0xF</span><span class="token punctuation">;</span>

        <span class="token comment">// Dump the rows which have 16 bytes.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> fullRows<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rowStartIndex <span class="token operator">=</span> <span class="token punctuation">(</span>row <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> startIndex<span class="token punctuation">;</span>

            <span class="token comment">// Per-row prefix.</span>
            <span class="token function">appendHexDumpRowPrefix</span><span class="token punctuation">(</span>dump<span class="token punctuation">,</span> row<span class="token punctuation">,</span> rowStartIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Hex dump</span>
            <span class="token keyword">int</span> rowEndIndex <span class="token operator">=</span> rowStartIndex <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> rowStartIndex<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> rowEndIndex<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">BYTE2HEX</span><span class="token punctuation">[</span><span class="token function">getUnsignedByte</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; |&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ASCII dump</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> rowStartIndex<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> rowEndIndex<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">BYTE2CHAR</span><span class="token punctuation">[</span><span class="token function">getUnsignedByte</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Dump the last row which has less than 16 bytes.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rowStartIndex <span class="token operator">=</span> <span class="token punctuation">(</span>fullRows <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> startIndex<span class="token punctuation">;</span>
            <span class="token function">appendHexDumpRowPrefix</span><span class="token punctuation">(</span>dump<span class="token punctuation">,</span> fullRows<span class="token punctuation">,</span> rowStartIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Hex dump</span>
            <span class="token keyword">int</span> rowEndIndex <span class="token operator">=</span> rowStartIndex <span class="token operator">+</span> remainder<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> rowStartIndex<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> rowEndIndex<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">BYTE2HEX</span><span class="token punctuation">[</span><span class="token function">getUnsignedByte</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">HEXPADDING</span><span class="token punctuation">[</span>remainder<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; |&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Ascii dump</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> rowStartIndex<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> rowEndIndex<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">BYTE2CHAR</span><span class="token punctuation">[</span><span class="token function">getUnsignedByte</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">BYTEPADDING</span><span class="token punctuation">[</span>remainder<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">NEWLINE</span> <span class="token operator">+</span>
                <span class="token string">&quot;+--------+-------------------------------------------------+----------------+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">appendHexDumpRowPrefix</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> dump<span class="token punctuation">,</span> <span class="token keyword">int</span> row<span class="token punctuation">,</span> <span class="token keyword">int</span> rowStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>row <span class="token operator">&lt;</span> <span class="token constant">HEXDUMP_ROWPREFIXES</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">HEXDUMP_ROWPREFIXES</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">NEWLINE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>rowStartIndex <span class="token operator">&amp;</span> <span class="token number">0</span>xFFFFFFFFL <span class="token operator">|</span> <span class="token number">0</span>x100000000L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dump<span class="token punctuation">.</span><span class="token function">setCharAt</span><span class="token punctuation">(</span>dump<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dump<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">short</span> <span class="token function">getUnsignedByte</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br></div></div><h3 id="_2-3-bytebuffer-常见方法"><a href="#_2-3-bytebuffer-常见方法" class="header-anchor">#</a> 2.3 ByteBuffer 常见方法</h3> <h4 id="分配空间"><a href="#分配空间" class="header-anchor">#</a> 分配空间</h4> <p>可以使用 allocate 方法为 ByteBuffer 分配空间，其它 buffer 类也有该方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Bytebuffer</span> buf <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="向-buffer-写入数据"><a href="#向-buffer-写入数据" class="header-anchor">#</a> 向 buffer 写入数据</h4> <p>有两种办法</p> <ul><li>调用 channel 的 read 方法</li> <li>调用 buffer 自己的 put 方法</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> readBytes <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>和</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>buf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="从-buffer-读取数据"><a href="#从-buffer-读取数据" class="header-anchor">#</a> 从 buffer 读取数据</h4> <p>同样有两种办法</p> <ul><li>调用 channel 的 write 方法</li> <li>调用 buffer 自己的 get 方法</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> writeBytes <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>和</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">byte</span> b <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>get 方法会让 position 读指针向后走，如果想重复读取数据</p> <ul><li>可以调用 rewind 方法将 position 重新置为 0</li> <li>或者调用 get(int i) 方法获取索引 i 的内容，它不会移动读指针</li></ul> <h4 id="mark-和-reset"><a href="#mark-和-reset" class="header-anchor">#</a> mark 和 reset</h4> <p>mark 是在读取时，做一个标记，即使 position 改变，只要调用 reset 就能回到 mark 的位置</p> <blockquote><p><strong>注意</strong></p> <p>rewind 和 flip 都会清除 mark 位置</p></blockquote> <h4 id="字符串与-bytebuffer-互转"><a href="#字符串与-bytebuffer-互转" class="header-anchor">#</a> 字符串与 ByteBuffer 互转</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ByteBuffer</span> buffer1 <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ByteBuffer</span> buffer2 <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">debug</span><span class="token punctuation">(</span>buffer1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">debug</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CharBuffer</span> buffer3 <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>buffer3<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>buffer3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| e4 bd a0 e5 a5 bd                               |......          |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| e4 bd a0 e5 a5 bd                               |......          |
+--------+-------------------------------------------------+----------------+
class java.nio.HeapCharBuffer
你好
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="⚠️-buffer-的线程安全"><a href="#⚠️-buffer-的线程安全" class="header-anchor">#</a> ⚠️ Buffer 的线程安全</h4> <blockquote><p>Buffer 是<strong>非线程安全的</strong></p></blockquote> <h3 id="_2-4-scattering-reads"><a href="#_2-4-scattering-reads" class="header-anchor">#</a> 2.4 Scattering Reads</h3> <p>分散读取，有一个文本文件 3parts.txt</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>onetwothree
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用如下方式读取，可以将数据填充至多个 buffer</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">RandomAccessFile</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/3parts.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> a <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> b <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> c <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>结果</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6f 6e 65                                        |one             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 77 6f                                        |two             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 68 72 65 65                                  |three           |
+--------+-------------------------------------------------+----------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-5-gathering-writes"><a href="#_2-5-gathering-writes" class="header-anchor">#</a> 2.5 Gathering Writes</h3> <p>使用如下方式写入，可以将多个 buffer 的数据填充至 channel</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">RandomAccessFile</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/3parts.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> d <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> e <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    d<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token char">'f'</span><span class="token punctuation">,</span> <span class="token char">'o'</span><span class="token punctuation">,</span> <span class="token char">'u'</span><span class="token punctuation">,</span> <span class="token char">'r'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token char">'f'</span><span class="token punctuation">,</span> <span class="token char">'i'</span><span class="token punctuation">,</span> <span class="token char">'v'</span><span class="token punctuation">,</span> <span class="token char">'e'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>d<span class="token punctuation">,</span> e<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 6f 75 72                                     |four            |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 69 76 65                                     |five            |
+--------+-------------------------------------------------+----------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>文件内容</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>onetwothreefourfive
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-6-练习"><a href="#_2-6-练习" class="header-anchor">#</a> 2.6 练习</h3> <p>网络上有多条数据发送给服务端，数据之间使用 \n 进行分隔
但由于某种原因这些数据在接收时，被进行了重新组合，例如原始数据有3条为</p> <ul><li>Hello,world\n</li> <li>I'm zhangsan\n</li> <li>How are you?\n</li></ul> <p>变成了下面的两个 byteBuffer (黏包，半包)</p> <ul><li>Hello,world\nI'm zhangsan\nHo</li> <li>w are you?\n</li></ul> <p>现在要求你编写程序，将错乱的数据恢复成原始的按 \n 分隔的数据</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ByteBuffer</span> source <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//                     11            24</span>
    source<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Hello,world\nI'm zhangsan\nHo&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">split</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>

    source<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;w are you?\nhaha!\n&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">split</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    source<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldLimit <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLimit<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteBuffer</span> target <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> source<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 0 ~ limit</span>
            source<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            target<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从source 读，向 target 写</span>
            <span class="token function">debugAll</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            source<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>oldLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    source<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="_3-文件编程"><a href="#_3-文件编程" class="header-anchor">#</a> 3. 文件编程</h2> <h3 id="_3-1-filechannel"><a href="#_3-1-filechannel" class="header-anchor">#</a> 3.1 FileChannel</h3> <h4 id="⚠️-filechannel-工作模式"><a href="#⚠️-filechannel-工作模式" class="header-anchor">#</a> ⚠️ FileChannel 工作模式</h4> <blockquote><p>FileChannel 只能工作在阻塞模式下</p></blockquote> <h4 id="获取"><a href="#获取" class="header-anchor">#</a> 获取</h4> <p>不能直接打开 FileChannel，必须通过 FileInputStream、FileOutputStream 或者 RandomAccessFile 来获取 FileChannel，它们都有 getChannel 方法</p> <ul><li>通过 FileInputStream 获取的 channel 只能读</li> <li>通过 FileOutputStream 获取的 channel 只能写</li> <li>通过 RandomAccessFile 是否能读写根据构造 RandomAccessFile 时的读写模式决定</li></ul> <h4 id="读取"><a href="#读取" class="header-anchor">#</a> 读取</h4> <p>会从 channel 读取数据填充 ByteBuffer，返回值表示读到了多少字节，-1 表示到达了文件的末尾</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> readBytes <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="写入"><a href="#写入" class="header-anchor">#</a> 写入</h4> <p>写入的正确姿势如下， SocketChannel</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存入数据</span>
buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 切换读模式</span>

<span class="token keyword">while</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在 while 中调用 channel.write 是因为 write 方法并不能保证一次将 buffer 中的内容全部写入 channel</p> <h4 id="关闭"><a href="#关闭" class="header-anchor">#</a> 关闭</h4> <p>channel 必须关闭，不过调用了 FileInputStream、FileOutputStream 或者 RandomAccessFile 的 close 方法会间接地调用 channel 的 close 方法</p> <h4 id="位置"><a href="#位置" class="header-anchor">#</a> 位置</h4> <p>获取当前位置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">long</span> pos <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置当前位置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">long</span> newPos <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>newPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>设置当前位置时，如果设置为文件的末尾</p> <ul><li>这时读取会返回 -1</li> <li>这时写入，会追加内容，但要注意如果 position 超过了文件末尾，再写入时在新内容和原末尾之间会有空洞（00）</li></ul> <h4 id="大小"><a href="#大小" class="header-anchor">#</a> 大小</h4> <p>使用 size 方法获取文件的大小</p> <h4 id="强制写入"><a href="#强制写入" class="header-anchor">#</a> 强制写入</h4> <p>操作系统出于性能的考虑，会将数据缓存，不是立刻写入磁盘。可以调用 force(true)  方法将文件内容和元数据（文件的权限等信息）立刻写入磁盘</p> <h3 id="_3-2-两个-channel-传输数据"><a href="#_3-2-两个-channel-传输数据" class="header-anchor">#</a> 3.2 两个 Channel 传输数据</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token constant">FROM</span> <span class="token operator">=</span> <span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> <span class="token constant">TO</span> <span class="token operator">=</span> <span class="token string">&quot;helloword/to.txt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileChannel</span> from <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token constant">FROM</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">FileChannel</span> <span class="token keyword">to</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token constant">TO</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    from<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> from<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;transferTo 用时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000_000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>transferTo 用时：8.2011
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>超过 2g 大小的文件传输</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFileChannelTransferTo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token class-name">FileChannel</span> from <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;data.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">FileChannel</span> <span class="token keyword">to</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;to.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 效率高，底层会利用操作系统的零拷贝进行优化</span>
            <span class="token keyword">long</span> size <span class="token operator">=</span> from<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// left 变量代表还剩余多少字节</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> left <span class="token operator">=</span> size<span class="token punctuation">;</span> left <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;position:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; left:&quot;</span> <span class="token operator">+</span> left<span class="token punctuation">)</span><span class="token punctuation">;</span>
                left <span class="token operator">-=</span> from<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">-</span> left<span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>实际传输一个超大文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>position:0 left:7769948160
position:2147483647 left:5622464513
position:4294967294 left:3474980866
position:6442450941 left:1327497219
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-3-path"><a href="#_3-3-path" class="header-anchor">#</a> 3.3 Path</h3> <p>jdk7 引入了 Path 和 Paths 类</p> <ul><li>Path 用来表示文件路径</li> <li>Paths 是工具类，用来获取 Path 实例</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> source <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;1.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 相对路径 使用 user.dir 环境变量来定位 1.txt</span>

<span class="token class-name">Path</span> source <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d:\\1.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绝对路径 代表了  d:\1.txt</span>

<span class="token class-name">Path</span> source <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d:/1.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绝对路径 同样代表了  d:\1.txt</span>

<span class="token class-name">Path</span> projects <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d:\\data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;projects&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 代表了  d:\data\projects</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><code>.</code> 代表了当前路径</li> <li><code>..</code> 代表了上一级路径</li></ul> <p>例如目录结构如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>d:
	|- data
		|- projects
			|- a
			|- b
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d:\\data\\projects\\a\\..\\b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正常化路径</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>d:\data\projects\a\..\b
d:\data\projects\b
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_3-4-files"><a href="#_3-4-files" class="header-anchor">#</a> 3.4 Files</h3> <p>检查文件是否存在</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建一级目录</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/d1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">createDirectory</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>如果目录已存在，会抛异常 FileAlreadyExistsException</li> <li>不能一次创建多级目录，否则会抛异常 NoSuchFileException</li></ul> <p>创建多级目录用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/d1/d2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">createDirectories</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>拷贝文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> source <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Path</span> target <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/target.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>如果文件已存在，会抛异常 FileAlreadyExistsException</li></ul> <p>如果希望用 source 覆盖掉 target，需要用 StandardCopyOption 来控制</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token class-name">StandardCopyOption</span><span class="token punctuation">.</span><span class="token constant">REPLACE_EXISTING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>移动文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> source <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Path</span> target <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token class-name">StandardCopyOption</span><span class="token punctuation">.</span><span class="token constant">ATOMIC_MOVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>StandardCopyOption.ATOMIC_MOVE 保证文件移动的原子性</li></ul> <p>删除文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> target <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/target.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>如果文件不存在，会抛异常 NoSuchFileException</li></ul> <p>删除目录</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> target <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/d1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>如果目录还有内容，会抛异常 DirectoryNotEmptyException</li></ul> <p>遍历目录文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\Program Files\\Java\\jdk1.8.0_91&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicInteger</span> dirCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicInteger</span> fileCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">walkFileTree</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleFileVisitor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">FileVisitResult</span> <span class="token function">preVisitDirectory</span><span class="token punctuation">(</span><span class="token class-name">Path</span> dir<span class="token punctuation">,</span> <span class="token class-name">BasicFileAttributes</span> attrs<span class="token punctuation">)</span> 
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dirCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preVisitDirectory</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">FileVisitResult</span> <span class="token function">visitFile</span><span class="token punctuation">(</span><span class="token class-name">Path</span> file<span class="token punctuation">,</span> <span class="token class-name">BasicFileAttributes</span> attrs<span class="token punctuation">)</span> 
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fileCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dirCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 133</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fileCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1479</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>统计 jar 的数目</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\Program Files\\Java\\jdk1.8.0_91&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AtomicInteger</span> fileCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">walkFileTree</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleFileVisitor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">FileVisitResult</span> <span class="token function">visitFile</span><span class="token punctuation">(</span><span class="token class-name">Path</span> file<span class="token punctuation">,</span> <span class="token class-name">BasicFileAttributes</span> attrs<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fileCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 724</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>删除多级目录</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d:\\a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">walkFileTree</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleFileVisitor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">FileVisitResult</span> <span class="token function">visitFile</span><span class="token punctuation">(</span><span class="token class-name">Path</span> file<span class="token punctuation">,</span> <span class="token class-name">BasicFileAttributes</span> attrs<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">FileVisitResult</span> <span class="token function">postVisitDirectory</span><span class="token punctuation">(</span><span class="token class-name">Path</span> dir<span class="token punctuation">,</span> <span class="token class-name">IOException</span> exc<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postVisitDirectory</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> exc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="⚠️-删除很危险"><a href="#⚠️-删除很危险" class="header-anchor">#</a> ⚠️ 删除很危险</h4> <blockquote><p>删除是危险操作，确保要递归删除的文件夹没有重要内容</p></blockquote> <p>拷贝多级目录</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token string">&quot;D:\\Snipaste-1.16.2-x64&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> target <span class="token operator">=</span> <span class="token string">&quot;D:\\Snipaste-1.16.2-x64aaa&quot;</span><span class="token punctuation">;</span>

<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>path <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> targetName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 是目录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">createDirectory</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>targetName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 是普通文件</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">isRegularFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>targetName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="_4-网络编程"><a href="#_4-网络编程" class="header-anchor">#</a> 4. 网络编程</h2> <h3 id="_4-1-非阻塞-vs-阻塞"><a href="#_4-1-非阻塞-vs-阻塞" class="header-anchor">#</a> 4.1 非阻塞 vs 阻塞</h3> <h4 id="阻塞"><a href="#阻塞" class="header-anchor">#</a> 阻塞</h4> <ul><li>阻塞模式下，相关方法都会导致线程暂停
<ul><li>ServerSocketChannel.accept 会在没有连接建立时让线程暂停</li> <li>SocketChannel.read 会在没有数据可读时让线程暂停</li> <li>阻塞的表现其实就是线程暂停了，暂停期间不会占用 cpu，但线程相当于闲置</li></ul></li> <li>单线程下，阻塞方法之间相互影响，几乎不能正常工作，需要多线程支持</li> <li>但多线程下，有新的问题，体现在以下方面
<ul><li>32 位 jvm 一个线程 320k，64 位 jvm 一个线程 1024k，如果连接数过多，必然导致 OOM，并且线程太多，反而会因为频繁上下文切换导致性能降低</li> <li>可以采用线程池技术来减少线程数和线程上下文切换，但治标不治本，如果有很多连接建立，但长时间 inactive，会阻塞线程池中所有线程，因此不适合长连接，只适合短连接</li></ul></li></ul> <p>服务器端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用 nio 来理解阻塞模式, 单线程</span>
<span class="token comment">// 0. ByteBuffer</span>
<span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1. 创建了服务器</span>
<span class="token class-name">ServerSocketChannel</span> ssc <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 绑定监听端口</span>
ssc<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 连接集合</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> channels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4. accept 建立与客户端连接， SocketChannel 用来与客户端之间通信</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;connecting...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻塞方法，线程停止运行</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;connected... {}&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    channels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> channel <span class="token operator">:</span> channels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 5. 接收客户端发送的数据</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;before read... {}&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻塞方法，线程停止运行</span>
        buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">debugRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;after read...{}&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;waiting...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="非阻塞"><a href="#非阻塞" class="header-anchor">#</a> 非阻塞</h4> <ul><li>非阻塞模式下，相关方法都会不会让线程暂停
<ul><li>在 ServerSocketChannel.accept 在没有连接建立时，会返回 null，继续运行</li> <li>SocketChannel.read 在没有数据可读时，会返回 0，但线程不必阻塞，可以去执行其它 SocketChannel 的 read 或是去执行 ServerSocketChannel.accept</li> <li>写数据时，线程只是等待数据写入 Channel 即可，无需等 Channel 通过网络把数据发送出去</li></ul></li> <li>但非阻塞模式下，即使没有连接建立，和可读数据，线程仍然在不断运行，白白浪费了 cpu</li> <li>数据复制过程中，线程实际还是阻塞的（AIO 改进的地方）</li></ul> <p>服务器端，客户端代码不变</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用 nio 来理解非阻塞模式, 单线程</span>
<span class="token comment">// 0. ByteBuffer</span>
<span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1. 创建了服务器</span>
<span class="token class-name">ServerSocketChannel</span> ssc <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ssc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞模式</span>
<span class="token comment">// 2. 绑定监听端口</span>
ssc<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3. 连接集合</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> channels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4. accept 建立与客户端连接， SocketChannel 用来与客户端之间通信</span>
    <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞，线程还会继续运行，如果没有连接建立，但sc是null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;connected... {}&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞模式</span>
        channels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> channel <span class="token operator">:</span> channels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 5. 接收客户端发送的数据</span>
        <span class="token keyword">int</span> read <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 非阻塞，线程仍然会继续运行，如果没有读到数据，read 返回 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">debugRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;after read...{}&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="多路复用"><a href="#多路复用" class="header-anchor">#</a> 多路复用</h4> <p>单线程可以配合 Selector 完成对多个 Channel 可读写事件的监控，这称之为多路复用</p> <ul><li>多路复用仅针对网络 IO、普通文件 IO 没法利用多路复用</li> <li>如果不用 Selector 的非阻塞模式，线程大部分时间都在做无用功，而 Selector 能够保证
<ul><li>有可连接事件时才去连接</li> <li>有可读事件才去读取</li> <li>有可写事件才去写入
<ul><li>限于网络传输能力，Channel 未必时时可写，一旦 Channel 可写，会触发 Selector 的可写事件</li></ul></li></ul></li></ul> <h3 id="_4-2-selector"><a href="#_4-2-selector" class="header-anchor">#</a> 4.2 Selector</h3> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TD
<span class="token keyword">subgraph</span> selector 版
thread <span class="token arrow operator">--&gt;</span> selector
selector <span class="token arrow operator">--&gt;</span> c1<span class="token text string">(channel)</span>
selector <span class="token arrow operator">--&gt;</span> c2<span class="token text string">(channel)</span>
selector <span class="token arrow operator">--&gt;</span> c3<span class="token text string">(channel)</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>好处</p> <ul><li>一个线程配合 selector 就可以监控多个 channel 的事件，事件发生线程才去处理。避免非阻塞模式下所做无用功</li> <li>让这个线程能够被充分利用</li> <li>节约了线程的数量</li> <li>减少了线程上下文切换</li></ul> <h4 id="创建"><a href="#创建" class="header-anchor">#</a> 创建</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="绑定-channel-事件"><a href="#绑定-channel-事件" class="header-anchor">#</a> 绑定 Channel 事件</h4> <p>也称之为注册事件，绑定的事件 selector 才会关心</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> 绑定事件<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>channel 必须工作在非阻塞模式</li> <li>FileChannel 没有非阻塞模式，因此不能配合 selector 一起使用</li> <li>绑定的事件类型可以有
<ul><li>connect - 客户端连接成功时触发</li> <li>accept - 服务器端成功接受连接时触发</li> <li>read - 数据可读入时触发，有因为接收能力弱，数据暂不能读入的情况</li> <li>write - 数据可写出时触发，有因为发送能力弱，数据暂不能写出的情况</li></ul></li></ul> <h4 id="监听-channel-事件"><a href="#监听-channel-事件" class="header-anchor">#</a> 监听 Channel 事件</h4> <p>可以通过下面三种方法来监听是否有事件发生，方法的返回值代表有多少 channel 发生了事件</p> <p>方法1，阻塞直到绑定事件发生</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> count <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>方法2，阻塞直到绑定事件发生，或是超时（时间单位为 ms）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> count <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>方法3，不会阻塞，也就是不管有没有事件，立刻返回，自己根据返回值检查是否有事件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> count <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="💡-select-何时不阻塞"><a href="#💡-select-何时不阻塞" class="header-anchor">#</a> 💡 select 何时不阻塞</h4> <blockquote><ul><li>事件发生时
<ul><li>客户端发起连接请求，会触发 accept 事件</li> <li>客户端发送数据过来，客户端正常、异常关闭时，都会触发 read 事件，另外如果发送的数据大于 buffer 缓冲区，会触发多次读取事件</li> <li>channel 可写，会触发 write 事件</li> <li>在 linux 下 nio bug 发生时</li></ul></li> <li>调用 selector.wakeup()</li> <li>调用 selector.close()</li> <li>selector 所在线程 interrupt</li></ul></blockquote> <h3 id="_4-3-处理-accept-事件"><a href="#_4-3-处理-accept-事件" class="header-anchor">#</a> 4.3 处理 accept 事件</h3> <p>客户端代码为</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>服务器端代码为</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelDemo6</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                int count = selector.selectNow();</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;select count: {}&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                if(count &lt;= 0) {</span>
<span class="token comment">//                    continue;</span>
<span class="token comment">//                }</span>

                <span class="token comment">// 获取所有事件</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 遍历所有事件，逐一处理</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 判断事件类型</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">ServerSocketChannel</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 必须处理</span>
                        <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 处理完毕，必须将事件移除</span>
                    iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="💡-事件发生后能否不处理"><a href="#💡-事件发生后能否不处理" class="header-anchor">#</a> 💡 事件发生后能否不处理</h4> <blockquote><p>事件发生后，要么处理，要么取消（cancel），不能什么都不做，否则下次该事件仍会触发，这是因为 nio 底层使用的是水平触发</p></blockquote> <h3 id="_4-4-处理-read-事件"><a href="#_4-4-处理-read-事件" class="header-anchor">#</a> 4.4 处理 read 事件</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelDemo6</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                int count = selector.selectNow();</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;select count: {}&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                if(count &lt;= 0) {</span>
<span class="token comment">//                    continue;</span>
<span class="token comment">//                }</span>

                <span class="token comment">// 获取所有事件</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 遍历所有事件，逐一处理</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 判断事件类型</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">ServerSocketChannel</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 必须处理</span>
                        <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;连接已建立: {}&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> read <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">debug</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 处理完毕，必须将事件移除</span>
                    iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>开启两个客户端，修改一下发送文字，输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - 连接已建立: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - 连接已建立: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 6f 72 6c 64                                  |world           |
+--------+-------------------------------------------------+----------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="💡-为何要-iter-remove"><a href="#💡-为何要-iter-remove" class="header-anchor">#</a> 💡 为何要 iter.remove()</h4> <blockquote><p>因为 select 在事件发生后，就会将相关的 key 放入 selectedKeys 集合，但不会在处理完后从 selectedKeys 集合中移除，需要我们自己编码删除。例如</p> <ul><li>第一次触发了 ssckey 上的 accept 事件，没有移除 ssckey</li> <li>第二次触发了 sckey 上的 read 事件，但这时 selectedKeys 中还有上次的 ssckey ，在处理时因为没有真正的 serverSocket 连上了，就会导致空指针异常</li></ul></blockquote> <h4 id="💡-cancel-的作用"><a href="#💡-cancel-的作用" class="header-anchor">#</a> 💡 cancel 的作用</h4> <blockquote><p>cancel 会取消注册在 selector 上的 channel，并从 keys 集合中删除 key 后续不会再监听事件</p></blockquote> <h4 id="⚠️-不处理边界的问题"><a href="#⚠️-不处理边界的问题" class="header-anchor">#</a> ⚠️  不处理边界的问题</h4> <p>以前有同学写过这样的代码，思考注释中两个问题，以 bio 为例，其实 nio 道理是一样的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerSocket</span> ss<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Socket</span> s <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InputStream</span> in <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这里这么写，有没有问题</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> read <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 这里这么写，有没有问题</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> read<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Socket</span> max <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> max<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;你好&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        max<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>hell
owor
ld�
�好

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>为什么？</p> <h4 id="处理消息的边界"><a href="#处理消息的边界" class="header-anchor">#</a> 处理消息的边界</h4> <p><img src="/assets/img/0023.3b9638a1.png" alt=""></p> <ul><li>一种思路是固定消息长度，数据包大小一样，服务器按预定长度读取，缺点是浪费带宽</li> <li>另一种思路是按分隔符拆分，缺点是效率低</li> <li>TLV 格式，即 Type 类型、Length 长度、Value 数据，类型和长度已知的情况下，就可以方便获取消息大小，分配合适的 buffer，缺点是 buffer 需要提前分配，如果内容过大，则影响 server 吞吐量
<ul><li>Http 1.1 是 TLV 格式</li> <li>Http 2.0 是 LTV 格式</li></ul></li></ul> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">sequenceDiagram</span> 
<span class="token keyword">participant</span> c1 as 客户端1
<span class="token keyword">participant</span> s as 服务器
<span class="token keyword">participant</span> b1 as ByteBuffer1
<span class="token keyword">participant</span> b2 as ByteBuffer2
c1 <span class="token arrow operator">-&gt;&gt;</span> s<span class="token operator">:</span> 发送 01234567890abcdef3333\r
s <span class="token arrow operator">-&gt;&gt;</span> b1<span class="token operator">:</span> 第一次 read 存入 01234567890abcdef
s <span class="token arrow operator">-&gt;&gt;</span> b2<span class="token operator">:</span> 扩容
b1 <span class="token arrow operator">-&gt;&gt;</span> b2<span class="token operator">:</span> 拷贝 01234567890abcdef
s <span class="token arrow operator">-&gt;&gt;</span> b2<span class="token operator">:</span> 第二次 read 存入 3333\r
b2 <span class="token arrow operator">-&gt;&gt;</span> b2<span class="token operator">:</span> 01234567890abcdef3333\r
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>服务器端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    source<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> source<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 找到一条完整消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> length <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> source<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 把这条完整消息存入新的 ByteBuffer</span>
            <span class="token class-name">ByteBuffer</span> target <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 从 source 读，向 target 写</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">debugAll</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    source<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0123456789abcdef  position 16 limit 16</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 创建 selector, 管理多个 channel</span>
    <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServerSocketChannel</span> ssc <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ssc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 建立 selector 和 channel 的联系（注册）</span>
    <span class="token comment">// SelectionKey 就是将来事件发生后，通过它可以知道事件和哪个channel的事件</span>
    <span class="token class-name">SelectionKey</span> sscKey <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// key 只关注 accept 事件</span>
    sscKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;sscKey:{}&quot;</span><span class="token punctuation">,</span> sscKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ssc<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3. select 方法, 没有事件发生，线程阻塞，有事件，线程才会恢复运行</span>
        <span class="token comment">// select 在事件未处理时，它不会阻塞, 事件发生后要么处理，要么取消，不能置之不理</span>
        selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 处理事件, selectedKeys 内部包含了所有发生的事件</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// accept, read</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理key 时，要从 selectedKeys 集合中删除，否则下次处理就会有问题</span>
            iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;key: {}&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5. 区分事件类型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是 accept</span>
                <span class="token class-name">ServerSocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// attachment</span>
                <span class="token comment">// 将一个 byteBuffer 作为附件关联到 selectionKey 上</span>
                <span class="token class-name">SelectionKey</span> scKey <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                scKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;scKey:{}&quot;</span><span class="token punctuation">,</span> scKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是 read</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拿到触发事件的channel</span>
                    <span class="token comment">// 获取 selectionKey 上关联的附件</span>
                    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> read <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是正常断开，read 的方法的返回值是 -1</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">split</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 需要扩容</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ByteBuffer</span> newBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0123456789abcdef3333\n</span>
                            key<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>newBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 因为客户端断开了,因此需要将 key 取消（从 selector 的 keys 集合中真正删除 key）</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SocketAddress</span> address <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// sc.write(Charset.defaultCharset().encode(&quot;hello\nworld\n&quot;));</span>
sc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;0123\n456789abcdef&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;0123456789abcdef3333\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="bytebuffer-大小分配"><a href="#bytebuffer-大小分配" class="header-anchor">#</a> ByteBuffer 大小分配</h4> <ul><li>每个 channel 都需要记录可能被切分的消息，因为 ByteBuffer 不能被多个 channel 共同使用，因此需要为每个 channel 维护一个独立的 ByteBuffer</li> <li>ByteBuffer 不能太大，比如一个 ByteBuffer 1Mb 的话，要支持百万连接就要 1Tb 内存，因此需要设计大小可变的 ByteBuffer
<ul><li>一种思路是首先分配一个较小的 buffer，例如 4k，如果发现数据不够，再分配 8k 的 buffer，将 4k buffer 内容拷贝至 8k buffer，优点是消息连续容易处理，缺点是数据拷贝耗费性能，参考实现 <a href="http://tutorials.jenkov.com/java-performance/resizable-array.html" target="_blank" rel="noopener noreferrer">http://tutorials.jenkov.com/java-performance/resizable-array.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>另一种思路是用多个数组组成 buffer，一个数组不够，把多出来的内容写入新的数组，与前面的区别是消息存储不连续解析复杂，优点是避免了拷贝引起的性能损耗</li></ul></li></ul> <h3 id="_4-5-处理-write-事件"><a href="#_4-5-处理-write-事件" class="header-anchor">#</a> 4.5 处理 write 事件</h3> <h4 id="一次无法写完例子"><a href="#一次无法写完例子" class="header-anchor">#</a> 一次无法写完例子</h4> <ul><li>非阻塞模式下，无法保证把 buffer 中所有数据都写入 channel，因此需要追踪 write 方法的返回值（代表实际写入字节数）</li> <li>用 selector 监听所有 channel 的可写事件，每个 channel 都需要一个 key 来跟踪 buffer，但这样又会导致占用内存过多，就有两阶段策略
<ul><li>当消息处理器第一次写入消息时，才将 channel 注册到 selector 上</li> <li>selector 检查 channel 上的可写事件，如果所有的数据写完了，就取消 channel 的注册</li> <li>如果不取消，会每次可写均会触发 write 事件</li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriteServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerSocketChannel</span> ssc <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssc<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SelectionKey</span> sckey <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 1. 向客户端发送内容</span>
                    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> write <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 3. write 表示实际写了多少字节</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;实际写入字节:&quot;</span> <span class="token operator">+</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 4. 如果有剩余未读字节，才需要关注写事件</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// read 1  write 4</span>
                        <span class="token comment">// 在原有关注事件的基础上，多关注 写事件</span>
                        sckey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>sckey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 把 buffer 作为附件加入 sckey</span>
                        sckey<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> write <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;实际写入字节:&quot;</span> <span class="token operator">+</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 写完了</span>
                        key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        key<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriteClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isConnectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    count <span class="token operator">+=</span> sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="💡-write-为何要取消"><a href="#💡-write-为何要取消" class="header-anchor">#</a> 💡 write 为何要取消</h4> <p>只要向 channel 发送数据时，socket 缓冲可写，这个事件会频繁触发，因此应当只在 socket 缓冲区写不下时再关注可写事件，数据写完之后再取消关注</p> <h3 id="_4-6-更进一步"><a href="#_4-6-更进一步" class="header-anchor">#</a> 4.6 更进一步</h3> <h4 id="💡-利用多线程优化"><a href="#💡-利用多线程优化" class="header-anchor">#</a> 💡 利用多线程优化</h4> <blockquote><p>现在都是多核 cpu，设计时要充分考虑别让 cpu 的力量被白白浪费</p></blockquote> <p>前面的代码只有一个选择器，没有充分利用多核 cpu，如何改进呢？</p> <p>分两组选择器</p> <ul><li>单线程配一个选择器，专门处理 accept 事件</li> <li>创建 cpu 核心数的线程，每个线程配一个选择器，轮流处理 read 事件</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelDemo7</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">BossEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BossEventLoop</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Selector</span> boss<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">WorkerEventLoop</span><span class="token punctuation">[</span><span class="token punctuation">]</span> workers<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> start <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> index <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ServerSocketChannel</span> ssc <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ssc<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ssc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                boss <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SelectionKey</span> ssckey <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>boss<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ssckey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                workers <span class="token operator">=</span> <span class="token function">initEventLoops</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;boss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;boss start...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                start <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">WorkerEventLoop</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initEventLoops</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];</span>
            <span class="token class-name">WorkerEventLoop</span><span class="token punctuation">[</span><span class="token punctuation">]</span> workerEventLoops <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkerEventLoop</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workerEventLoops<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                workerEventLoops<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkerEventLoop</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> workerEventLoops<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    boss<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> boss<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ServerSocketChannel</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{} connected&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            workers<span class="token punctuation">[</span>index<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> workers<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WorkerEventLoop</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Selector</span> worker<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> start <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">WorkerEventLoop</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> sc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                worker <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;worker-&quot;</span> <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                start <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SelectionKey</span> sckey <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sckey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    worker<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            worker<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    worker<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> worker<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token keyword">int</span> read <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    sc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{} message:&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token function">debugAll</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                sc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br></div></div><h4 id="💡-如何拿到-cpu-个数"><a href="#💡-如何拿到-cpu-个数" class="header-anchor">#</a> 💡 如何拿到 cpu 个数</h4> <blockquote><ul><li>Runtime.getRuntime().availableProcessors() 如果工作在 docker 容器下，因为容器不是物理隔离的，会拿到物理 cpu 个数，而不是容器申请时的个数</li> <li>这个问题直到 jdk 10 才修复，使用 jvm 参数 UseContainerSupport 配置， 默认开启</li></ul></blockquote> <h3 id="_4-7-udp"><a href="#_4-7-udp" class="header-anchor">#</a> 4.7 UDP</h3> <ul><li>UDP 是无连接的，client 发送数据不会管 server 是否开启</li> <li>server 这边的 receive 方法会将接收到的数据存入 byte buffer，但如果数据报文超过 buffer 大小，多出来的数据会被默默抛弃</li></ul> <p>首先启动服务器端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdpServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">DatagramChannel</span> channel <span class="token operator">=</span> <span class="token class-name">DatagramChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;waiting...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">debug</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>waiting...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdpClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">DatagramChannel</span> channel <span class="token operator">=</span> <span class="token class-name">DatagramChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InetSocketAddress</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>接下来服务器端输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_5-nio-vs-bio"><a href="#_5-nio-vs-bio" class="header-anchor">#</a> 5. NIO vs BIO</h2> <h3 id="_5-1-stream-vs-channel"><a href="#_5-1-stream-vs-channel" class="header-anchor">#</a> 5.1 stream vs channel</h3> <ul><li>stream 不会自动缓冲数据，channel 会利用系统提供的发送缓冲区、接收缓冲区（更为底层）</li> <li>stream 仅支持阻塞 API，channel 同时支持阻塞、非阻塞 API，网络 channel 可配合 selector 实现多路复用</li> <li>二者均为全双工，即读写可以同时进行</li></ul> <h3 id="_5-2-io-模型"><a href="#_5-2-io-模型" class="header-anchor">#</a> 5.2 IO 模型</h3> <p>同步阻塞、同步非阻塞、同步多路复用、异步阻塞（没有此情况）、异步非阻塞</p> <ul><li>同步：线程自己去获取结果（一个线程）</li> <li>异步：线程自己不去获取结果，而是由其它线程送结果（至少两个线程）</li></ul> <p>当调用一次 channel.read 或 stream.read 后，会切换至操作系统内核态来完成真正数据读取，而读取又分为两个阶段，分别为：</p> <ul><li>等待数据阶段</li> <li>复制数据阶段</li></ul> <p><img src="/assets/img/0033.9beda40e.png" alt=""></p> <ul><li><p>阻塞 IO</p> <p><img src="/assets/img/0039.d6140fbe.png" alt=""></p></li> <li><p>非阻塞  IO</p> <p><img src="/assets/img/0035.bee47ff0.png" alt=""></p></li> <li><p>多路复用</p> <p><img src="/assets/img/0038.92295a6c.png" alt=""></p></li> <li><p>信号驱动</p></li> <li><p>异步 IO</p> <p><img src="/assets/img/0037.d24fd0f7.png" alt=""></p></li> <li><p>阻塞 IO vs 多路复用</p> <p><img src="/assets/img/0034.b1451587.png" alt=""></p> <p><img src="/assets/img/0036.fe68785f.png" alt=""></p></li></ul> <h4 id="🔖-参考"><a href="#🔖-参考" class="header-anchor">#</a> 🔖 参考</h4> <p>UNIX 网络编程 - 卷 I</p> <h3 id="_5-3-零拷贝"><a href="#_5-3-零拷贝" class="header-anchor">#</a> 5.3 零拷贝</h3> <h4 id="传统-io-问题"><a href="#传统-io-问题" class="header-anchor">#</a> 传统 IO 问题</h4> <p>传统的 IO 将一个文件通过 socket 写出</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;helloword/data.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RandomAccessFile</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
file<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>内部工作流程是这样的：</p> <p><img src="data:image/png;base64,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" alt=""></p> <ol><li><p>java 本身并不具备 IO 读写能力，因此 read 方法调用后，要从 java 程序的<strong>用户态</strong>切换至<strong>内核态</strong>，去调用操作系统（Kernel）的读能力，将数据读入<strong>内核缓冲区</strong>。这期间用户线程阻塞，操作系统使用 DMA（Direct Memory Access）来实现文件读，其间也不会使用 cpu</p> <blockquote><p>DMA 也可以理解为硬件单元，用来解放 cpu 完成文件 IO</p></blockquote></li> <li><p>从<strong>内核态</strong>切换回<strong>用户态</strong>，将数据从<strong>内核缓冲区</strong>读入<strong>用户缓冲区</strong>（即 byte[] buf），这期间 cpu 会参与拷贝，无法利用 DMA</p></li> <li><p>调用 write 方法，这时将数据从<strong>用户缓冲区</strong>（byte[] buf）写入 <strong>socket 缓冲区</strong>，cpu 会参与拷贝</p></li> <li><p>接下来要向网卡写数据，这项能力 java 又不具备，因此又得从<strong>用户态</strong>切换至<strong>内核态</strong>，调用操作系统的写能力，使用 DMA 将 <strong>socket 缓冲区</strong>的数据写入网卡，不会使用 cpu</p></li></ol> <p>可以看到中间环节较多，java 的 IO 实际不是物理设备级别的读写，而是缓存的复制，底层的真正读写是操作系统来完成的</p> <ul><li>用户态与内核态的切换发生了 3 次，这个操作比较重量级</li> <li>数据拷贝了共 4 次</li></ul> <h4 id="nio-优化"><a href="#nio-优化" class="header-anchor">#</a> NIO 优化</h4> <p>通过 DirectByteBuf</p> <ul><li>ByteBuffer.allocate(10)  HeapByteBuffer 使用的还是 java 内存</li> <li>ByteBuffer.allocateDirect(10)  DirectByteBuffer 使用的是操作系统内存</li></ul> <p><img src="/assets/img/0025.c3dd38c4.png" alt=""></p> <p>大部分步骤与优化前相同，不再赘述。唯有一点：java 可以使用 DirectByteBuf 将堆外内存映射到 jvm 内存中来直接访问使用</p> <ul><li>这块内存不受 jvm 垃圾回收的影响，因此内存地址固定，有助于 IO 读写</li> <li>java 中的 DirectByteBuf 对象仅维护了此内存的虚引用，内存回收分成两步
<ul><li>DirectByteBuf 对象被垃圾回收，将虚引用加入引用队列</li> <li>通过专门线程访问引用队列，根据虚引用释放堆外内存</li></ul></li> <li>减少了一次数据拷贝，用户态与内核态的切换次数没有减少</li></ul> <p>进一步优化（底层采用了 linux 2.1 后提供的 sendFile 方法），java 中对应着两个 channel 调用 transferTo/transferFrom 方法拷贝数据</p> <p><img src="data:image/png;base64,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" alt=""></p> <ol><li>java 调用 transferTo 方法后，要从 java 程序的<strong>用户态</strong>切换至<strong>内核态</strong>，使用 DMA将数据读入<strong>内核缓冲区</strong>，不会使用 cpu</li> <li>数据从<strong>内核缓冲区</strong>传输到 <strong>socket 缓冲区</strong>，cpu 会参与拷贝</li> <li>最后使用 DMA 将 <strong>socket 缓冲区</strong>的数据写入网卡，不会使用 cpu</li></ol> <p>可以看到</p> <ul><li>只发生了一次用户态与内核态的切换</li> <li>数据拷贝了 3 次</li></ul> <p>进一步优化（linux 2.4）</p> <p><img src="data:image/png;base64,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" alt=""></p> <ol><li>java 调用 transferTo 方法后，要从 java 程序的<strong>用户态</strong>切换至<strong>内核态</strong>，使用 DMA将数据读入<strong>内核缓冲区</strong>，不会使用 cpu</li> <li>只会将一些 offset 和 length 信息拷入 <strong>socket 缓冲区</strong>，几乎无消耗</li> <li>使用 DMA 将 <strong>内核缓冲区</strong>的数据写入网卡，不会使用 cpu</li></ol> <p>整个过程仅只发生了一次用户态与内核态的切换，数据拷贝了 2 次。所谓的【零拷贝】，并不是真正无拷贝，而是在不会拷贝重复数据到 jvm 内存中，零拷贝的优点有</p> <ul><li>更少的用户态与内核态的切换</li> <li>不利用 cpu 计算，减少 cpu 缓存伪共享</li> <li>零拷贝适合小文件传输</li></ul> <h3 id="_5-3-aio"><a href="#_5-3-aio" class="header-anchor">#</a> 5.3 AIO</h3> <p>AIO 用来解决数据复制阶段的阻塞问题</p> <ul><li>同步意味着，在进行读写操作时，线程需要等待结果，还是相当于闲置</li> <li>异步意味着，在进行读写操作时，线程不必等待结果，而是将来由操作系统来通过回调方式由另外的线程来获得结果</li></ul> <blockquote><p>异步模型需要底层操作系统（Kernel）提供支持</p> <ul><li>Windows 系统通过 IOCP 实现了真正的异步 IO</li> <li>Linux 系统异步 IO 在 2.6 版本引入，但其底层实现还是用多路复用模拟了异步 IO，性能没有优势</li></ul></blockquote> <h4 id="文件-aio"><a href="#文件-aio" class="header-anchor">#</a> 文件 AIO</h4> <p>先来看看 AsynchronousFileChannel</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AioDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token class-name">AsynchronousFileChannel</span> s <span class="token operator">=</span> 
                <span class="token class-name">AsynchronousFileChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>
                	<span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;1.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardOpenOption</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;begin...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> result<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;read completed...{}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">debug</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;read failed...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;do other things...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...
13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...
13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 0d                                           |a.              |
+--------+-------------------------------------------------+----------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到</p> <ul><li>响应文件读取成功的是另一个线程 Thread-5</li> <li>主线程并没有 IO 操作阻塞</li></ul> <h4 id="💡-守护线程"><a href="#💡-守护线程" class="header-anchor">#</a> 💡 守护线程</h4> <p>默认文件 AIO 使用的线程都是守护线程，所以最后要执行 <code>System.in.read()</code> 以避免守护线程意外结束</p> <h4 id="网络-aio"><a href="#网络-aio" class="header-anchor">#</a> 网络 AIO</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AioServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">AsynchronousServerSocketChannel</span> ssc <span class="token operator">=</span> <span class="token class-name">AsynchronousServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssc<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssc<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AcceptHandler</span><span class="token punctuation">(</span>ssc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeChannel</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> sc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%s] %s close\n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AsynchronousSocketChannel</span> sc<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">ReadHandler</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> sc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sc <span class="token operator">=</span> sc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> result<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">closeChannel</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%s] %s read\n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachment<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>attachment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachment<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 处理完第一个 read 时，需要再次调用 read 方法来处理下一个 read 事件</span>
                sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>attachment<span class="token punctuation">,</span> attachment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">closeChannel</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            exc<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AsynchronousSocketChannel</span> sc<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">WriteHandler</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> sc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sc <span class="token operator">=</span> sc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> result<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果作为附件的 buffer 还有内容，需要再次 write 写出剩余内容</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attachment<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>attachment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            exc<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">closeChannel</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AcceptHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AsynchronousSocketChannel</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AsynchronousServerSocketChannel</span> ssc<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">AcceptHandler</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousServerSocketChannel</span> ssc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ssc <span class="token operator">=</span> ssc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> sc<span class="token punctuation">,</span> <span class="token class-name">Object</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%s] %s connected\n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读事件由 ReadHandler 处理</span>
            sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReadHandler</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 写事件由 WriteHandler 处理</span>
            sc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;server hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WriteHandler</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理完第一个 accpet 时，需要再次调用 accept 方法来处理下一个 accept 事件</span>
            ssc<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">Object</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            exc<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">🕣上次更新时间: </span> <span class="time">8/29/2023, 3:38:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/back/redis/快速入门.html" class="prev">
          快速入门
        </a></span> <span class="next"><a href="/back/netty/Netty02-入门.html">
          Netty入门
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_1-三大组件" class="sidebar-link reco-side-_1-三大组件" data-v-b57cc07c>1. 三大组件</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_1-1-channel-buffer" class="sidebar-link reco-side-_1-1-channel-buffer" data-v-b57cc07c>1.1 Channel &amp; Buffer</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_1-2-selector" class="sidebar-link reco-side-_1-2-selector" data-v-b57cc07c>1.2 Selector</a></li><li class="level-2" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-bytebuffer" class="sidebar-link reco-side-_2-bytebuffer" data-v-b57cc07c>2. ByteBuffer</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-1-bytebuffer-正确使用姿势" class="sidebar-link reco-side-_2-1-bytebuffer-正确使用姿势" data-v-b57cc07c>2.1  ByteBuffer 正确使用姿势</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-2-bytebuffer-结构" class="sidebar-link reco-side-_2-2-bytebuffer-结构" data-v-b57cc07c>2.2 ByteBuffer 结构</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-3-bytebuffer-常见方法" class="sidebar-link reco-side-_2-3-bytebuffer-常见方法" data-v-b57cc07c>2.3 ByteBuffer 常见方法</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-4-scattering-reads" class="sidebar-link reco-side-_2-4-scattering-reads" data-v-b57cc07c>2.4 Scattering Reads</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-5-gathering-writes" class="sidebar-link reco-side-_2-5-gathering-writes" data-v-b57cc07c>2.5 Gathering Writes</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_2-6-练习" class="sidebar-link reco-side-_2-6-练习" data-v-b57cc07c>2.6 练习</a></li><li class="level-2" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_3-文件编程" class="sidebar-link reco-side-_3-文件编程" data-v-b57cc07c>3. 文件编程</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_3-1-filechannel" class="sidebar-link reco-side-_3-1-filechannel" data-v-b57cc07c>3.1 FileChannel</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_3-2-两个-channel-传输数据" class="sidebar-link reco-side-_3-2-两个-channel-传输数据" data-v-b57cc07c>3.2 两个 Channel 传输数据</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_3-3-path" class="sidebar-link reco-side-_3-3-path" data-v-b57cc07c>3.3 Path</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_3-4-files" class="sidebar-link reco-side-_3-4-files" data-v-b57cc07c>3.4 Files</a></li><li class="level-2" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-网络编程" class="sidebar-link reco-side-_4-网络编程" data-v-b57cc07c>4. 网络编程</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-1-非阻塞-vs-阻塞" class="sidebar-link reco-side-_4-1-非阻塞-vs-阻塞" data-v-b57cc07c>4.1 非阻塞 vs 阻塞</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-2-selector" class="sidebar-link reco-side-_4-2-selector" data-v-b57cc07c>4.2 Selector</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-3-处理-accept-事件" class="sidebar-link reco-side-_4-3-处理-accept-事件" data-v-b57cc07c>4.3 处理 accept 事件</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-4-处理-read-事件" class="sidebar-link reco-side-_4-4-处理-read-事件" data-v-b57cc07c>4.4 处理 read 事件</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-5-处理-write-事件" class="sidebar-link reco-side-_4-5-处理-write-事件" data-v-b57cc07c>4.5 处理 write 事件</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-6-更进一步" class="sidebar-link reco-side-_4-6-更进一步" data-v-b57cc07c>4.6 更进一步</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_4-7-udp" class="sidebar-link reco-side-_4-7-udp" data-v-b57cc07c>4.7 UDP</a></li><li class="level-2" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_5-nio-vs-bio" class="sidebar-link reco-side-_5-nio-vs-bio" data-v-b57cc07c>5. NIO vs BIO</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_5-1-stream-vs-channel" class="sidebar-link reco-side-_5-1-stream-vs-channel" data-v-b57cc07c>5.1 stream vs channel</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_5-2-io-模型" class="sidebar-link reco-side-_5-2-io-模型" data-v-b57cc07c>5.2 IO 模型</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_5-3-零拷贝" class="sidebar-link reco-side-_5-3-零拷贝" data-v-b57cc07c>5.3 零拷贝</a></li><li class="level-3" data-v-b57cc07c><a href="/back/netty/Netty01-nio.html#_5-3-aio" class="sidebar-link reco-side-_5-3-aio" data-v-b57cc07c>5.3 AIO</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.3ef41cfa.js" defer></script><script src="/assets/js/4.db7ba0a9.js" defer></script><script src="/assets/js/1.80dd9a38.js" defer></script><script src="/assets/js/7.7c4ddee7.js" defer></script>
  </body>
</html>
